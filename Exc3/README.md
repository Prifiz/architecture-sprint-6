# Проблемы и риски, связанные с планируемым ростом нагрузки

* Множество операций, выполняемых ins-product-aggregator в рамках одного синхронного запроса
* Время на выполнение такого запроса сложно прогнозировать, т.к. оно зависит от времени ответа внешних поставщиков данных (страховых компаний)
* При увеличении кол-ва страховых компаний время ответа будет возрастать, причем характер этого роста сложно прогнозировать
* Проблема меньшего приоритета, но имеет место: задержки при получении и актуализации данных. При росте нагрузки кол-во предлагаемых и оформленных продуктов вырастет, и соответственно за те же самые периоды времени будет пропущено большее кол-во данных (напрмер клиент не сможет какое-то время видеть потенциальные новые предложения от страховых, и самих таких клиентов в перспективе станет больше)
* Имеет место риск распространения отказа на другие сервисы при ошибках в интеграции с конкретными страховыми (отказ например в одном взаимодействии, а по цепочке ошибки будут в бизнес-процессах, охватывающих другие сервисы)
* Как следствие возможная неконсистентность данных (несоответствие друг другу локальных реплик в сервисах core-app и ins-comp-settlement по тем данным, которые должны быть идентичны)
* Снижение общей надежности: если ошибки в получении данных например только от одной страховой, весь процесс обновления данных от всех страховых в aggregator упадет. Т.е. там, где могли бы получить данные от функционирующих интеграций, не получаем их
* Довольно странно: 
    * ins-comp-settlement раз в месяц он отправляет перечень оформленных страховок в страховые компании для расчёта выплаты агентских премий
	* Дополнительно сервис ins-comp-settlement раз в сутки осуществляет запрос в core-app по REST API для получения всех оформленных за день страховок.
    * То есть информация по факту нужна только раз в месяц, а опрос происходит каждый день
	
# Предлагаемое решение

## На Event-Streaming следует переделать следующие взаимодействия:

1. ins-product-aggregator - узкое место с синхронными обращениями. Предлагаю "заставить" его получать информацию о продуктах и тарифах из систем страховых компаний с необходимой периодичностью, агрегировать необходимым образом и размещать в топике брокера. Соответственно на этот топик будут подписаны core-app и ins-comp-settlement. Это позволит исключить синхронное ожидание выполнения, а также сгладить нагрузку.
2. Также предлагаю сделать так, чтобы core-app размещал в отдельном топике информацию об оформленных страховках (по мере оформления, опять-таки сглаживание и обеспечение своевременной синхронизации данных), а ins-comp-settlement соответственно подписан на этот топик

## Применение Transactional Outbox

Предлагаю использование Transactional Outbox для взаимодействия core-app и ins-comp-settlement. Поскольку core-app сохраняет данные об оформленных страховках в свою БД и также должен размещать в топике информацию о них, то применение паттерна позволит обеспечить целостность данных при выполнении этих двух операций.